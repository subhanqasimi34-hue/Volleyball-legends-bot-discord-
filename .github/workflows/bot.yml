name: Discord Bot 24-7

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: get repo
        uses: actions/checkout@v3

      - name: node setup idk
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: install stuff
        run: |
          npm install
          echo "install done maybe"

      - name: get cloudflared thing
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          echo "cloudflared downloaded??"

      - name: run tunnel (i hope)
        run: ./cloudflared tunnel run --token "$TUNNEL_TOKEN" &
        env:
          TUNNEL_TOKEN: ${{ secrets.TUNNEL_TOKEN }}

      - name: start bot lol
        run: |
          node src/indexV2.js &
          sleep 999999
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          APP_ID: ${{ secrets.APP_ID }}
          PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}
          CF_TUNNEL_ID: ${{ secrets.CF_TUNNEL_ID }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
