name: Discord Bot 24/7

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Install packages
      - name: Install dependencies
        run: npm install

      # Download cloudflared
      - name: Download cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      # Start the Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: ./cloudflared tunnel run --token "$TUNNEL_TOKEN" &
        env:
          TUNNEL_TOKEN: ${{ secrets.TUNNEL_TOKEN }}

      # Start the Discord bot (your bot file)
      - name: Start Discord Bot
        run: |
          node src/index.js &
          sleep 999999
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          APP_ID: ${{ secrets.APP_ID }}
          PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}
          CF_TUNNEL_ID: ${{ secrets.CF_TUNNEL_ID }}
